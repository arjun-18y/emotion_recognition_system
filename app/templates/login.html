{% extends 'base.html' %}
{% block content %}
<section class="panel auth-panel">
  <h2>Welcome Back</h2>
  <p class="lead">Login to continue emotion analysis.</p>
  <form id="loginForm">
    <input type="email" name="email" placeholder="Email" required>
    <input type="password" name="password" placeholder="Password" required>
    <button type="submit">Login</button>
  </form>
  <p><a href="/auth/register">New user? Register here</a></p>
  <p><a href="/auth/forgot">Forgot password?</a></p>
</section>
<script>
const form = document.getElementById('loginForm');
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const fd = new FormData(form);
  const payload = { email: fd.get('email'), password: fd.get('password') };
  try {
    const res = await fetch('/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const raw = await res.text();
    let data = {};
    try {
      data = raw ? JSON.parse(raw) : {};
    } catch (_) {
      data = { error: raw || 'Login failed' };
    }

    if (!res.ok) {
      alert(data.error || data.msg || 'Login failed');
      return;
    }
    localStorage.setItem('token', data.access_token);
    if (data.role === 'admin') {
      window.location.href = '/admin/dashboard';
      return;
    }
    window.location.href = '/predict/';
  } catch (err) {
    alert('Login request failed. Check server is running and try again.');
  }
});
</script>
{% endblock %}
